---
title: "MTBrush_paper"
author: "Yixing Tu"
date: "3/25/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Abstract

MTBrush is a R package that can be used to conduct and visualizing multiple hypothesis tests for high dimensional datasets. It allows users to perform large scale hypothesis testing by fiting a model based on their choices and visualize histograms of test statistics. It also contains an interactive platform allowing users to brush through histograms and query for interesting samples. By comparing the highlighted part in the histograms of different terms and with the help of corresponding scatter plots, users can easily identify whether the interaction terms have synergistic or competitive effects and then make informative conclusions. 

# Keywords

Multiple hypothesis testing, interaction diagrams, R package;

# Introduction

When dealing with high volume dataset like microbiome and microarray study, it is normal to perform large-scale testing and get a huge number of test statistics. It is tedious to analyze results from the multiple hypothesis testing procedure due to the large amount and the some seemed significant results due to the tolerant significant level. Visual graphs for statistics can help to grasp some information from the data. Studies involved multiple hypothesis testing use histogram of test statistics for each sample to help making interpretations, but this can be still hard to interpret. They are lacking the part of linking test statistics to the information form original dataset. It is especially hard to interpret plots as plots getting complex in some high dimensional and multivariate studies (Wills, 08). The solution is using linked data views. Not trying to make a complex plots explain everything from the data and test results, we could build several simpler parts and link them together to help to analyze the data. Brushing has been used for connected statistics on multiple levels to one another (Wickham), but there isn't one for models under multiple hypothesis settings. Therefore, this package is trying build the linked visualizations for multiple hypothesis testing studies.

idea: replace the traditional way of calculating log fold-changes, instead we fit ANOVA models. 

# Methods

## Implementation

The package contains five methods:

**split_dataset(df, group)**: This function splits the given data set into many smaller subsets based on the group. Each subset only contains measurements of a sample and all subsets take same measurements.

*parameters*: 

df: the given data frame;   
group: the name of the group column

*return*: groups of subsets

**fit_statistics(subsets, lm_func, group)**: This method helps to fit a model chosen by users for all groups of subset. 

*parameters*: 

subsets: groups of subset from split_dataset function;  
lm_func: the linear model chosen by user to fit the data;  
group: the name of the group column

*return*: a table with statistics of each term for all subsets

**draw_stats_histogram(stats_df)**: This function provides a part of the shiny app to generate several histograms of statistics for each term

*parameters*: 

stats_df: the output table from fit_statistics function

*return*: several histograms of all subsets based on terms in the model

**brush_plots_binary(df, stats_df, group_list, group, value)**: This method generates a shiny app displaying histograms of statistics and scatter plots and a table of selected observations. Use this function when the condition/explanatory variables have binary data type.

*parameters*: 

df: the processed data frame;  
stats_df: the output table from fit_statistics function;  
group_list: a list of distinct observations;  
group: the column name for grouping variable;  
value: the column name for response variable;

*return*: the shiny user interface contains histograms of statistics and scatter plots and a table of selected observations. 

**brush_plots_other(df, stats_df, group_list, group, value)**: This method is similar to brush_plots_binary. It also generates a shiny app displaying the histograms of statistics and scatter plots and a table of selected observations. Use this function when the condition/explanatory variables have non-binary data type.

*parameters*: 

df: the processed data frame;  
stats_df: the output table from fit_statistics function;  
group_list: a list of distinct observations;  
group: the column name for grouping variable;  
value: the column name for response variable;

*return*: the shiny user interface contains histograms of statistics and scatter plots and a table of selected observations.

![Workflow](/Users/tuyixing/Desktop/Course/research/workflow_pic.png)

## Operation

Before users make any interactions, the user interface of the generated Shiny app is made of a group of histograms of statistics and a scatter plot for all samples. Users can brush through any histogram to query for interesting samples, then the selected tail and the opposite end will be highlighted in different colors. The scatter plot will be replaced by a collection of scatter plots of selected samples, which allow users to check details on each selected samples. After brushing, a new section of table will show up. From the table, Users can also access the test statistics of each term for selected samples. 

![Interface before interaction](/Users/tuyixing/Desktop/Course/research/interface1.jpg)

A: Histograms of test statistics, brush through any one of the histogram to select samples;  
B: Before brushing, a scatter plot of all samples will appear to give an overall distribution of the dataset.  

![Interface after brushing](/Users/tuyixing/Desktop/Course/research/interface2.jpg)

C: After brushing, test statistics greater than and less than the threshold will be highlighted (red for positive and orange for negative values). The selected samples will be highlighted in all histograms;  
D: The scatter plots of top 12 samples in the table of selected samples will be shown here. By adding or deleting the chosen ID on the left select menu, users can choose to see the scatter plot of the sample they have interests on;  
E: By default, only 12 samples will be chosen at first. Users can use the drop down menu to follow the samples of interests;  
F: The table of selected samples in the brushed area. Color corresponds to the color in the upper histograms.

# Cases Studies

We illustrate the use of the `MTBrush` package using two case studies. Our
examples are drawn from very different problem areas — metabolomic and spatial
data analysis — but share common sources of complexity. Both problems require
the application of regression models in parallel across a large collection,
producing test statistics across both the terms in the model and members of the
collection. It is difficult to inspect results across both dimensions using raw
model output, and we illustrate how `MTBrush` can streamline the process.

## Discovering interactions in a model microbial system

Our first case study considers metabolomic expression patterns in “The
Hitchhicker’s of the Rhizosphere” (THOR) model microbial community. This model
system makes it possible to examine the microbial behaviors that only emerge
when multiple species are present in a shared environment. This provides a
controlled environment with which to begin probing the microbial strain-level
interactions that shape function in real-world microbiomes. We consider data
from this system from an experiment designed to characterize the influence of
species interactions on the community metabolome. Specifically, 12
configurations of the THOR system were grown, corresponding to the presence or
absence of each of three species, Bifidobacterium (todo?) (B), Flavobacterium
johnsonii (F), and either Pseudomonas Koreensis (K) or a corresponding mutant
whose ability to produce the antibiotic korreincene (todo?) has been knocked out
(Table X). Five replicates were gathered for each configuration, and each was
metabolically profiled using Liquid chromatography–mass spectrometry (LCMS). The
scientific goal of this study is to detect compounds whose expression in joint
communities (e.g., F + K) cannot be explained by simply interpolating expression
when each of the constituent species are present in isolation. These metabolites
may reflect higher-level competitive or synergistic effects within the
community.

The associated dataset contains 60 samples, each with expression measurements
across 3882 compounds. We frame the analysis as a parallel multiple hypothesis
testing problem. For each compound, we fit the saturated linear model
`log(Abundance) ~ B * F * K`. The main effects describe how the expression level
for a compound varies when the associated species are present or absent from the
community. Interaction effects measure the extent to which these effects are
modulated by coexistence of multiple species. For example, a strong, positive `F
: K` interaction terms for a compound suggests that, in the FK condition, the
compound is present at much higher levels than would be expected when only one
of F or K are present in isolation.

Figure `\ref{fig:thor_overview}` shows the MTBrush overview before the user has
provided any query. From the scatterplot, we observe that the distribution of
data points is relatively uniform across conditions and there are no extreme
outliers.

![Example1.1](/Users/tuyixing/Desktop/Course/research/before.png)

In the figure below, we brushed compounds with large, positive F effects. The
reflected negative effect compounds are in orange. In this selection, the
associated FK effects are mostly positive and the associated BFK effects are
mostly negative (compare the orange bulk within this panel with 0). A possible
explanation is that these selected, orange compounds are consumed by F, which is
why they decrease in the presence of F. The positive FK effects suggest that 
these compounds are not being consumed as rapidly when K is present. This is
consistent with our understanding of the system...

But when all three
are present, the compound is less abundant again, it is an evidence for B
protecting F.

In this way, MTBrush has helped clarify the mechanisms that underlie emergent phenomena that have 

![Example1.2](/Users/tuyixing/Desktop/Course/research/Thor_example.png)

## Navigating California home prices

Our next example uses `MTBrush` to support exploration of the California Housing Price dataset \cite{give citation}. This dataset includes prices of 20,640 homes, together with features of the homes and their neighborhoods, including the number of rooms and neighborhood’s median income, for example. These data are often used to evaluate supervised learning methods. Our focus instead is to visualize how the conditions of a home and neighborhood relate to observed prices, and how these effects vary geographically.

Specifically, to understand how the influence of home and neighborhood features are modulated by geographic location, we partition the dataset into geographically disjoint sets and fit a linear model within each. The coefficients from these models can be plotted as histograms and brushed to identify features that are important in some locations but not others. Since some locations have many more houses than others, partitioning the data with a simple geographic grid would result in highly imbalanced sample sizes across the ensemble. For areas with limited number of houses, the results would not be comparable to those in areas with larger sample sizes. To address this, we first apply K-means to the geographic coordinates of the observed homes, resulting in 2064 clusters with more balanced sample sizes.

Figure \ref{fig:homestart} shows the distribution of variable features before any user interactions. From this overview, we notice that the home prices are inversely related to the population density. In Figure \ref{fig:homebrush}, we brushed to highlight those houses with positive households effects. We find that the corresponding households and median income interaction effects are negative, suggesting that median income restrains the positive effects of households. Specifically, an increase in  the median income of a neighborhood has a smaller effect on average home price when the number of households in that neighborhood is large. When the population variable is also added, the three-way interaction term seems to have a positive effects again. 

For this dataset, it is typical to fit a single nonlinear model use it to make predictions for house price. Interpreting the result of this fit can be challenging, however. In contrast, by interacting with a full ensemble of simple models, we can easily compare geographic variation in effects, using individual panels to observe characteristics of individual homes in each area.

![Example2](/Users/tuyixing/Desktop/Course/research/example2.png)

# Discussion

This package help to perform a multiple hypothesis testing for similar samples in a large number of groups. After clean the data into the type of input data on the pipeline, given a model, we can easily apply the model to all the groups and visualize test statistics. Then by brushing through linked diagrams, we can interpret the data in a more intuitive and efficient way. 

However, this package has limited ability to check the correctness and effectiveness of the model and we do not implement the multiple hypothesis testing outputs, so it is a more conceptual link. We give users the freedom to use their own model and believe that it is valid. In the further study, we could have a more complete process of hypothesis testing including null and alternative hypothesis. We should also pay attention to the p-value and think about how to avoid rejecting the null hypothesis due to the tolerance of significant level when dealing with a bunch of test statistics.  Also, there is only one brush per panel so the information get from the plots are limited. We are not allowed to select several regions form the same panel and compare them. Lastly, the data type of variables is limited either binary or non-binary type. No better strategies for datasets with mixing of binary and non-binary variables.
